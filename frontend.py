import streamlit as st
import requests
import json

# рЃЕрЃћрЃЏрЃў Back-end рЃАрЃћрЃарЃЋрЃћрЃарЃўрЃА рЃЏрЃўрЃАрЃљрЃЏрЃљрЃарЃЌрЃў (Render-рЃќрЃћ)
API_URL = "https://documind-api-z6cq.onrender.com/analyze-cv"

st.set_page_config(page_title="DocuMind - AI HR Assistant", layout="centered")

st.title("­ЪЊё DocuMind: Smart CV Analyzer")
st.markdown("рЃљрЃбрЃЋрЃўрЃарЃЌрЃћрЃЌ CV рЃЊрЃљ рЃЋрЃљрЃЎрЃљрЃюрЃАрЃўрЃўрЃА рЃљрЃдрЃгрЃћрЃарЃљ. AI рЃњрЃљрЃљрЃљрЃюрЃљрЃџрЃўрЃќрЃћрЃЉрЃА рЃерЃћрЃАрЃљрЃЉрЃљрЃЏрЃўрЃАрЃЮрЃЉрЃљрЃА.")

# 1. рЃцрЃљрЃўрЃџрЃўрЃА рЃљрЃбрЃЋрЃўрЃарЃЌрЃЋрЃўрЃА рЃАрЃћрЃЦрЃфрЃўрЃљ
uploaded_file = st.file_uploader("CV-рЃўрЃА рЃљрЃбрЃЋрЃўрЃарЃЌрЃЋрЃљ (PDF рЃљрЃю DOCX)", type=["pdf", "docx"])

# 2. рЃЋрЃљрЃЎрЃљрЃюрЃАрЃўрЃўрЃА рЃбрЃћрЃЦрЃАрЃбрЃўрЃА рЃерЃћрЃАрЃљрЃДрЃЋрЃљрЃюрЃў рЃЋрЃћрЃџрЃў
job_description = st.text_area("рЃЋрЃљрЃЎрЃљрЃюрЃАрЃўрЃўрЃА рЃљрЃдрЃгрЃћрЃарЃљ (Job Description)", height=200)

# 3. рЃњрЃљрЃњрЃќрЃљрЃЋрЃюрЃўрЃА рЃдрЃўрЃџрЃљрЃЎрЃў рЃЊрЃљ рЃџрЃЮрЃњрЃўрЃЎрЃљ
if st.button("­Ъџђ рЃљрЃюрЃљрЃџрЃўрЃќрЃўрЃА рЃЊрЃљрЃгрЃДрЃћрЃЉрЃљ"):
    if uploaded_file and job_description:
        with st.spinner("рЃЏрЃўрЃЏрЃЊрЃўрЃюрЃљрЃарЃћрЃЮрЃЉрЃА рЃЏрЃЮрЃюрЃљрЃфрЃћрЃЏрЃћрЃЉрЃўрЃА рЃЊрЃљрЃЏрЃБрЃерЃљрЃЋрЃћрЃЉрЃљ..."):
            try:
                # рЃцрЃљрЃўрЃџрЃўрЃА рЃЊрЃљ рЃбрЃћрЃЦрЃАрЃбрЃўрЃА рЃЏрЃЮрЃЏрЃќрЃљрЃЊрЃћрЃЉрЃљ API-рЃАрЃЌрЃЋрЃўрЃА
                files = {"file": (uploaded_file.name, uploaded_file, uploaded_file.type)}
                data = {"job_description": job_description}

                # рЃЏрЃЮрЃЌрЃ«рЃЮрЃЋрЃюрЃўрЃА рЃњрЃљрЃњрЃќрЃљрЃЋрЃюрЃљ рЃЕрЃћрЃЏрЃА рЃАрЃћрЃарЃЋрЃћрЃарЃќрЃћ (POST request)
                response = requests.post(API_URL, files=files, data=data)

                # рЃърЃљрЃАрЃБрЃ«рЃўрЃА рЃерЃћрЃЏрЃЮрЃгрЃЏрЃћрЃЉрЃљ
                if response.status_code == 200:
                    result = response.json()
                    
                    # рЃЋрЃўрЃќрЃБрЃљрЃџрЃБрЃарЃў рЃерЃћрЃЊрЃћрЃњрЃћрЃЉрЃўрЃА рЃњрЃљрЃЏрЃЮрЃбрЃљрЃюрЃљ
                    st.success("рЃљрЃюрЃљрЃџрЃўрЃќрЃў рЃгрЃљрЃарЃЏрЃљрЃбрЃћрЃЉрЃўрЃЌ рЃЊрЃљрЃАрЃарЃБрЃџрЃЊрЃљ!")
                    
                    # 1. рЃЦрЃБрЃџрЃљ (Score)
                    score = result.get("match_score", 0)
                    st.metric(label="рЃерЃћрЃАрЃљрЃЉрЃљрЃЏрЃўрЃАрЃЮрЃЉрЃўрЃА рЃЦрЃБрЃџрЃљ", value=f"{score}/100")
                    st.progress(score)

                    # 2. рЃЊрЃћрЃбрЃљрЃџрЃБрЃарЃў рЃарЃћрЃърЃЮрЃарЃбрЃў
                    st.subheader("­ЪЊЮ рЃерЃћрЃ»рЃљрЃЏрЃћрЃЉрЃљ")
                    st.write(result.get("summary", "рЃўрЃюрЃцрЃЮрЃарЃЏрЃљрЃфрЃўрЃљ рЃљрЃа рЃљрЃарЃўрЃА"))

                    st.subheader("Рџа№ИЈ рЃњрЃљрЃЏрЃЮрЃАрЃљрЃАрЃгрЃЮрЃарЃћрЃЉрЃћрЃџрЃў/рЃюрЃљрЃЎрЃџрЃБрЃџрЃў рЃБрЃюрЃљрЃарЃћрЃЉрЃў")
                    for skill in result.get("missing_skills", []):
                        st.write(f"- РЮї {skill}")

                    st.subheader("­ЪњА рЃарЃћрЃЎрЃЮрЃЏрЃћрЃюрЃЊрЃљрЃфрЃўрЃљ")
                    st.info(result.get("recommendation", "рЃарЃЕрЃћрЃЋрЃљ рЃљрЃа рЃљрЃарЃўрЃА"))

                else:
                    st.error(f"рЃАрЃћрЃарЃЋрЃћрЃарЃўрЃА рЃерЃћрЃфрЃЊрЃЮрЃЏрЃљ: {response.text}")

            except Exception as e:
                st.error(f"рЃЊрЃљрЃЎрЃљрЃЋрЃерЃўрЃарЃћрЃЉрЃўрЃА рЃърЃарЃЮрЃЉрЃџрЃћрЃЏрЃљ: {str(e)}")
    else:
        st.warning("рЃљрЃБрЃфрЃўрЃџрЃћрЃЉрЃћрЃџрЃўрЃљ рЃцрЃљрЃўрЃџрЃўрЃА рЃљрЃбрЃЋрЃўрЃарЃЌрЃЋрЃљ рЃЊрЃљ рЃЋрЃљрЃЎрЃљрЃюрЃАрЃўрЃўрЃА рЃбрЃћрЃЦрЃАрЃбрЃўрЃА рЃерЃћрЃДрЃЋрЃљрЃюрЃљ.")